# backend/app/utils/logger.py\n\"\"\"\nLogging configuration for ContentFlow.\nProvides structured logging with JSON formatting.\n\"\"\"\n\nimport logging\nimport sys\nimport json\nfrom datetime import datetime\nfrom pathlib import Path\n\nfrom app.config import settings\n\n\nclass JSONFormatter(logging.Formatter):\n    \"\"\"Custom formatter that outputs JSON logs\"\"\"\n\n    def format(self, record: logging.LogRecord) -> str:\n        log_data = {\n            \"timestamp\": datetime.utcnow().isoformat(),\n            \"level\": record.levelname,\n            \"logger\": record.name,\n            \"message\": record.getMessage(),\n            \"module\": record.module,\n            \"function\": record.funcName,\n            \"line\": record.lineno,\n        }\n\n        if record.exc_info:\n            log_data[\"exception\"] = self.formatException(record.exc_info)\n\n        if hasattr(record, \"request_id\"):\n            log_data[\"request_id\"] = record.request_id\n\n        return json.dumps(log_data, default=str)\n\n\ndef setup_logger(name: str) -> logging.Logger:\n    \"\"\"\n    Set up a logger with configured handlers.\n\n    Args:\n        name: Logger name (usually __name__)\n\n    Returns:\n        Configured logger instance\n    \"\"\"\n    logger = logging.getLogger(name)\n    logger.setLevel(getattr(logging, settings.LOG_LEVEL))\n\n    # Remove existing handlers\n    logger.handlers.clear()\n\n    # Console handler\n    console_handler = logging.StreamHandler(sys.stdout)\n    console_handler.setLevel(getattr(logging, settings.LOG_LEVEL))\n\n    if settings.LOG_FORMAT == \"json\":\n        formatter = JSONFormatter()\n    else:\n        formatter = logging.Formatter(\n            fmt=\"%(asctime)s - %(name)s - %(levelname)s - %(message)s\",\n            datefmt=\"%Y-%m-%d %H:%M:%S\",\n        )\n\n    console_handler.setFormatter(formatter)\n    logger.addHandler(console_handler)\n\n    # File handler (if not in development)\n    if settings.ENVIRONMENT != \"development\":\n        log_dir = Path(\"logs\")\n        log_dir.mkdir(exist_ok=True)\n\n        file_handler = logging.FileHandler(\n            log_dir / f\"contentflow_{settings.ENVIRONMENT}.log\"\n        )\n        file_handler.setLevel(logging.INFO)\n        file_handler.setFormatter(formatter)\n        logger.addHandler(file_handler)\n\n    return logger\n\n\n# Initialize Sentry if configured\nif settings.SENTRY_DSN:\n    import sentry_sdk\n\n    sentry_sdk.init(\n        dsn=settings.SENTRY_DSN,\n        environment=settings.ENVIRONMENT,\n        traces_sample_rate=0.1,\n        debug=settings.DEBUG,\n    )\n\n\n# ============================================================================\n# backend/app/utils/exceptions.py\n# ============================================================================\n\n\"\"\"\nCustom exception classes for ContentFlow.\n\"\"\"\n\nfrom typing import Optional, Dict, Any\n\n\nclass ContentFlowException(Exception):\n    \"\"\"\n    Base exception for ContentFlow application.\n    All custom exceptions should inherit from this.\n    \"\"\"\n\n    def __init__(\n        self,\n        detail: str,\n        code: str = \"CONTENT_FLOW_ERROR\",\n        status_code: int = 500,\n        extra_data: Optional[Dict[str, Any]] = None,\n    ):\n        self.detail = detail\n        self.code = code\n        self.status_code = status_code\n        self.extra_data = extra_data or {}\n        super().__init__(self.detail)\n\n    def __repr__(self):\n        return f\"<{self.__class__.__name__} code={self.code} detail={self.detail}>\"\n\n\nclass ValidationError(ContentFlowException):\n    \"\"\"Raised when input validation fails\"\"\"\n\n    def __init__(self, detail: str, extra_data: Optional[Dict] = None):\n        super().__init__(\n            detail=detail,\n            code=\"VALIDATION_ERROR\",\n            status_code=400,\n            extra_data=extra_data,\n        )\n\n\nclass NotFoundError(ContentFlowException):\n    \"\"\"Raised when a resource is not found\"\"\"\n\n    def __init__(self, resource: str, resource_id: str):\n        super().__init__(\n            detail=f\"{resource} with ID {resource_id} not found\",\n            code=\"NOT_FOUND\",\n            status_code=404,\n        )\n\n\nclass AuthenticationError(ContentFlowException):\n    \"\"\"Raised when authentication fails\"\"\"\n\n    def __init__(self, detail: str = \"Authentication failed\"):\n        super().__init__(\n            detail=detail,\n            code=\"AUTHENTICATION_ERROR\",\n            status_code=401,\n        )\n\n\nclass AuthorizationError(ContentFlowException):\n    \"\"\"Raised when user is not authorized for an action\"\"\"\n\n    def __init__(self, detail: str = \"Not authorized\"):\n        super().__init__(\n            detail=detail,\n            code=\"AUTHORIZATION_ERROR\",\n            status_code=403,\n        )\n\n\nclass RateLimitError(ContentFlowException):\n    \"\"\"Raised when rate limit is exceeded\"\"\"\n\n    def __init__(self, detail: str = \"Rate limit exceeded\"):\n        super().__init__(\n            detail=detail,\n            code=\"RATE_LIMIT_EXCEEDED\",\n            status_code=429,\n        )\n\n\nclass ExternalServiceError(ContentFlowException):\n    \"\"\"Raised when an external service fails\"\"\"\n\n    def __init__(self, service: str, detail: str):\n        super().__init__(\n            detail=f\"Error from {service}: {detail}\",\n            code=\"EXTERNAL_SERVICE_ERROR\",\n            status_code=502,\n            extra_data={\"service\": service},\n        )\n\n\nclass ProcessingError(ContentFlowException):\n    \"\"\"Raised when content processing fails\"\"\"\n\n    def __init__(self, detail: str, step: Optional[str] = None):\n        super().__init__(\n            detail=detail,\n            code=\"PROCESSING_ERROR\",\n            status_code=500,\n            extra_data={\"step\": step} if step else {},\n        )\n\n\nclass VectorStoreError(ContentFlowException):\n    \"\"\"Raised when vector store operations fail\"\"\"\n\n    def __init__(self, detail: str):\n        super().__init__(\n            detail=detail,\n            code=\"VECTOR_STORE_ERROR\",\n            status_code=500,\n        )\n\n\nclass LLMError(ContentFlowException):\n    \"\"\"Raised when LLM operations fail\"\"\"\n\n    def __init__(self, detail: str, model: Optional[str] = None):\n        super().__init__(\n            detail=detail,\n            code=\"LLM_ERROR\",\n            status_code=502,\n            extra_data={\"model\": model} if model else {},\n        )\n"
